name: Izettle Products Docker
on:
  push:
    branches:
      - master

env:
  DOCKERFILE: products/izettle/Dockerfile
  BUILD_CONTEXT: products/izettle/
  IMAGE_NAME: izettle-products.backend
  REGISTRY: https://docker.pkg.github.com
  TAG_PREFIX: docker.pkg.github.com/${{ github.repository }}
  USERNAME: 09cowlingj+bot@gmail.com

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: docker build
        uses: docker://docker:19.03.8
        with:
          entrypoint: docker
          args: build --tag "${{ env.TAG_PREFIX }}/${{ env.IMAGE_NAME }}:latest" --file "${{ env.DOCKERFILE }}" "${{ env.BUILD_CONTEXT }}"
      - name: get version from label
        uses: docker://docker:19.03.8
        with:
          entrypoint: echo
          args: "`docker inspect \"${{ env.TAG_PREFIX }}/${{ env.IMAGE_NAME }}:latest\" --format '{{ index .Config.Labels \"version\" }}'` > ${HOME}/version.txt"
      - name: set version in environment
        run: |-
          echo ::set-env "name=VERSION::$(cat ${HOME}/version.txt)"
          rm ${HOME}/version.txt
      - name: DEBUG
        uses: docker://docker:19.03.8
        with:
          entrypoint: echo
          args: ${{ env.VERSION }}
      - name: tag with version
        uses: docker://docker:19.03.8
        with:
          entrypoint: docker
          args: tag "${{ env.TAG_PREFIX }}/${{ env.IMAGE_NAME }}:latest" "${{ env.TAG_PREFIX }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
      - name: docker login
        uses: docker://docker:19.03.8
        with:
          entrypoint: docker
          args: login --username "${{ env.USERNAME }}" --password "${{ secrets.DOCKER_PASSWORD }}" "${{ env.REGISTRY }}"
      - name: docker push
        uses: docker://docker:19.03.8
        with:
          entrypoint: docker
          args: push "${{ env.TAG_PREFIX }}/${{ env.IMAGE_NAME }}:latest"
      - name: docker push
        uses: docker://docker:19.03.8
        with:
          entrypoint: docker
          args: push "${{ env.TAG_PREFIX }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
