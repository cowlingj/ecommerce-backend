ServerRoot "/usr/local/apache2"

LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authn_file_module modules/mod_authn_file.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
LoadModule authz_user_module modules/mod_authz_user.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule access_compat_module modules/mod_access_compat.so
LoadModule auth_basic_module modules/mod_auth_basic.so
LoadModule reqtimeout_module modules/mod_reqtimeout.so
LoadModule include_module modules/mod_include.so
LoadModule mime_module modules/mod_mime.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule env_module modules/mod_env.so
LoadModule headers_module modules/mod_headers.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule status_module modules/mod_status.so
LoadModule dir_module modules/mod_dir.so
LoadModule alias_module modules/mod_alias.so
LoadModule macro_module modules/mod_macro.so

<IfModule unixd_module>
  User httpd
  Group httpd
</IfModule>

ErrorLog /proc/self/fd/2
LogLevel warn

# Access log
<IfModule log_config_module>
    LogFormat "%h %l %u %t \"%r\" %>s %b" common
    CustomLog /proc/self/fd/1 common
</IfModule>

# mitigate httpoxy exploit
<IfModule headers_module>
    RequestHeader unset Proxy early
</IfModule>

<IfModule mime_module>
    TypesConfig conf/mime.types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
</IfModule>

<IfModule ssl_module>
  SSLRandomSeed startup builtin
  SSLRandomSeed connect builtin
</IfModule>

<IfModule mod_reqtimeout>
  RequestReadTimeout header=10-30,MinRate=500 body=30-60,MinRate=500
</IfModule>

Listen ${PORT}
Listen ${STATUS_PORT}

<Macro Base>
  ServerAdmin ${ADMIN_EMAIL}
  Alias "${BASE_PATH}" "/home/httpd/www"

  <Directory "/">
    AllowOverride none
    Require all denied
  </Directory>

  # requests to dir go to corresponding index.html
  <IfModule dir_module>
      DirectoryIndex index.html
  </IfModule>

  # deny access to .htaccess and .htpasswd
  <Files ".ht*">
      Require all denied
  </Files>
</Macro>

<VirtualHost *:${PORT}>
  DocumentRoot "/home/httpd/www"

  Use Base

  <Directory "/home/httpd/www">
    AllowOverride None
    Require all granted

    Options +Includes
    AddOutputFilter INCLUDES .html

    PassEnv ENDPOINTS_INFO
  </Directory>
</VirtualHost>

# apache metrics endpoint
<VirtualHost *:${STATUS_PORT}>

  Use Base

  <IfModule status_module>
    <Location "/status">
      Require all granted
      SetHandler server-status
    </Location>
  </IfModule>
</VirtualHost>
