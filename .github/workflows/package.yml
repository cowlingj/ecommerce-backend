name: Package
on:
  push:
    branches:
      - master
jobs:
  package:
    name: main
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - name: cms
            directory: "${GITHUB_WORKSPACE}/cms/main"
    steps:
      - name: "docker login"
        uses: actions/docker/login@master
        env:
          DOCKER_REGISTRY_URL: "docker.pkg.github.com"
          DOCKER_USERNAME: "${{ secrets.GITHUB_DOCKER_USERNAME }}"
          DOCKER_PASSWORD: "${{ secrets.GITHUB_ACCESS_TOKEN }}"
      - name: "git checkout"
        uses: actions/checkout@master
      - name: "docker build"
        uses: actions/docker/cli@master
        with:
          args: "build -t ${{ matrix.project.name }} ${{ matrix.project.directory }}"
      - name: "docker tag"
        uses: actions/docker/tag@master
        with:
          entrypoint: "sh"
          args: "echo ${PATH}; /bin/tag --env-file ${HOME}/tags ${{ matrix.project.name }} docker.pkg.github.com/${GITHUB_REPOSITORY}/${{ matrix.project.name }}"
      
      - name: "set env"
        run: "source ${HOME}/tags"
        shell: "bash"
      - name: "list env (testing env persistence)"
        run: "env"
        shell: "bash"
      
      - name: "docker push"
        uses: actions/docker/cli@master
        with:
          entrypoint: "sh"
          args: >
            source ${HOME}/tags;
            docker push
            docker.pkg.github.com/${GITHUB_REPOSITORY}/${{ matrix.project.name }}:latest
            docker.pkg.github.com/${GITHUB_REPOSITORY}/${{ matrix.project.name }}:latest
            docker.pkg.github.com/${GITHUB_REPOSITORY}/${{ matrix.project.name }}:latest
            docker.pkg.github.com/${GITHUB_REPOSITORY}/${{ matrix.project.name }}:latest
