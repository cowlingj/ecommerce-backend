# SECRETS:
# HELM_REPO_PREFIX - url for the helm repo (/helm/repo is appended to complete full url)
# HELM_REPO_BRANCH - branch for push to helm repo
# GIT_USER_NAME - username for git account to use
# GIT_USER_EMAIL - email for git account to use
# GITHUB_TOKEN - github personal access token (requires permission to commit to repo)
# GCP_SERVICE_KEY - key for gcp service account (backslash sequences must be escaped)
# GCP_PROJECT_ID - gcp project id
# GCP_ZONE - gcp compute zone
# GCP_REGISTRY_PREFIX - the registry prefix to use for gcp container registry (determines storage location)
---

version: 2.1

orbs:
  node: circleci/node@1.1.6

workflows:
  version: 2

  package:
    jobs:
      - build-cms-main:
          filters:
            branches:
              only: master
      - build-products-api:
          filters:
            branches:
              only: master
      - build-izettle-products:
          filters:
            branches:
              only: master
          requires:
            - build-products-api
      - build-cms-init:
          filters:
            branches:
              only: master
      - git-commit-packages:
          filters:
            branches:
              only: master
          requires:
            - build-products-api

  update_helm_charts:
    jobs:
      - package-helpers:
          filters:
            branches:
              only: master
      - package-nginx-ingress:
          filters:
            branches:
              only: master
      - package-istio-ingress:
          filters:
            branches:
              only: master
      - package-mongodb-config:
          filters:
            branches:
              only: master
          requires:
            - package-helpers
      - package-cms:
          filters:
            branches:
              only: master
          requires:
            - package-helpers
      - package-izettle-products:
          filters:
            branches:
              only: master
          requires:
            - package-helpers
      - package-backend:
          filters:
            branches:
              only: master
          requires:
            - package-nginx-ingress
            - package-istio-ingress
            - package-cms
            - package-izettle-products
            - package-helpers
            - package-mongodb-config
      - generate-index:
          filters:
            branches:
              only: master
          requires:
            - package-nginx-ingress
            - package-istio-ingress
            - package-cms
            - package-izettle-products
            - package-helpers
            - package-mongodb-config
            - package-backend
      - git-commit-repo:
          filters:
            branches:
              only: master
          requires:
            - generate-index

executors:
  gcloud:
    shell: /bin/sh -le
    docker:
      - image: google/cloud-sdk
  alpine:
    shell: /bin/sh -le
    docker:
      - image: alpine:latest
  git:
    shell: /bin/sh -le
    docker:
      - image: alpine/git:1.0.7
  helm:
    shell: /bin/sh -le
    docker:
      - image: praqma/helmsman:v1.12.0

jobs:
  build-cms-main:
    executor: gcloud
    steps:
      - docker_package:
          image: "cms.admin"
          path: "cms/main/"
  build-cms-init:
    executor: gcloud
    steps:
      - docker_package:
          image: "init.cms.admin"
          path: "cms/init/"
  build-izettle-products:
    executor: gcloud
    steps:
      - docker_package:
          image: "izettle-products.backend"
          path: "products/izettle"
  build-products-api:
    executor:
      name: node/default
      tag: '12.14.1'
    steps:
      - npm_package:
          path: "~/project/products/api"

  package-helpers:
    executor: helm
    steps:
      - helm_package:
          path: helm/charts/helpers/
  package-nginx-ingress:
    executor: helm
    steps:
      - helm_package:
          path: helm/charts/nginx-ingress/
  package-istio-ingress:
    executor: helm
    steps:
      - helm_package:
          path: helm/charts/istio-ingress/
  package-mongodb-config:
    executor: helm
    steps:
      - helm_package:
          path: mongodb/charts/mongodb-config/
  package-cms:
    executor: helm
    steps:
      - helm_package:
          path: cms/charts/cms/
  package-izettle-products:
    executor: helm
    steps:
      - helm_package:
          path: products/charts/izettle-products/
  package-backend:
    executor: helm
    steps:
      - helm_package:
          path: helm/charts/ecommerce-backend/
  generate-index:
    executor: helm
    steps:
      - generate_index
  git-commit-repo:
    executor: git
    steps:
      - commit_if_workspace_different:
          message: "Update helm repo"
          overwrite: true
  git-commit-packages:
    executor: git
    steps:
      - commit_if_workspace_different:
          message: "Update packages"
          workspace_dir: packages
          src_dir: packages/node

commands:
  docker_package:
    parameters:
      image:
        type: string
      path:
        type: string
    steps:
      - setup_remote_docker
      - checkout
      - run:
          name: Setup GCP
          command: |
            echo "${GCP_SERVICE_KEY}" | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project ${GCP_PROJECT_ID}
            gcloud --quiet config set compute/zone ${GCP_ZONE}
            gcloud auth configure-docker
      - run:
          name: Docker build
          command: docker build -t tmp << parameters.path >>
      - run:
          name: Set image version
          command: docker inspect tmp --format '{{ index .Config.Labels "version" }}' > /tmp/image_version
      - run:
          name: Docker tag
          command: |
            docker tag tmp "${GCP_REGISTRY_PREFIX}/${GCP_PROJECT_ID}/<< parameters.image >>:$(cat /tmp/image_version)"
            docker tag tmp "${GCP_REGISTRY_PREFIX}/${GCP_PROJECT_ID}/<< parameters.image >>:latest"
      - deploy:
          name: Docker push
          command: |
            docker push "${GCP_REGISTRY_PREFIX}/${GCP_PROJECT_ID}/<< parameters.image >>:$(cat /tmp/image_version)"
            docker push "${GCP_REGISTRY_PREFIX}/${GCP_PROJECT_ID}/<< parameters.image >>:latest"
  npm_package:
    parameters:
      path:
        type: string
    steps:
      - checkout
      - run:
          name: "package"
          command: |
            mkdir --parents /tmp/packages
            cd /tmp/packages
            npm pack << parameters.path >>
      - persist_to_workspace:
          root: /tmp/
          paths:
            - "packages"
  helm_package:
    parameters:
      path:
        type: string
    steps:
      - checkout
      - run:
          name: helm init
          command: helm init --client-only
      - run:
          name: helm package
          command: |
            mkdir --parents /tmp/helm/repo
            helm package --dependency-update --destination /tmp/helm/repo/ << parameters.path >>
      - persist_to_workspace:
          root: /tmp/
          paths:
            - "helm/repo/*"
  generate_index:
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: helm repo index
          command: |
            helm repo index --url ${HELM_REPO_PREFIX}/helm/repo/ /tmp/workspace/helm/repo/
            mkdir --parents /tmp/helm/repo
            mv /tmp/workspace/helm/repo/index.yaml /tmp/helm/repo/index.yaml
      - persist_to_workspace:
          root: /tmp/
          paths:
            - "helm/repo/index.yaml"
  commit_if_workspace_different:
    parameters:
      workspace_dir:
        type: string
        default: ""
      src_dir:
        type: string
        default: "."
      message:
        type: string
      attempts:
        type: integer
        default: 3
      overwrite:
        type: boolean
        default: false
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: git config
          command: |
            git config user.name "${GIT_USER_NAME}"
            git config user.email "${GIT_USER_EMAIL}"
      - run:
          name: replace files
          command: |
            mkdir -p << parameters.src_dir >>
            if << parameters.overwrite >>; then
              cp -r /tmp/workspace/<< parameters.workspace_dir >>/. << parameters.src_dir >>
            else
              yes n | cp -i -r /tmp/workspace/<< parameters.workspace_dir >>/. << parameters.src_dir >>
            fi
      - run:
          name: possibly commit diff
          command: |
            git add --intent-to-add --all
            if ! git diff --quiet; then
              echo "changes detected, committing"
              git add --all
              git commit --message "[CIRCLE CI] [ci skip] << parameters.message >>"
              git pull --rebase
              PUSH_FAILS=0
              while ! git push --quiet \
                  https://${GITHUB_TOKEN}@github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.git 2>&1 \
                  HEAD:${HELM_REPO_BRANCH} | sed s/${GITHUB_TOKEN}/**********/; do
                if [ "$PUSH_FAILS" -ge "<< parameters.attempts >>" ]; then
                  exit 1
                fi
                git pull --rebase
                PUSH_FAILS="$(expr "$PUSH_FAILS" + 1)"
              done
            fi
