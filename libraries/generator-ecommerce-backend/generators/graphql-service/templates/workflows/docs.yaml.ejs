name: <%= app.displayName %> Docs
on:
  pull_request:
    paths:
      - '<%= app.path %>/app/package.json'
      - '<%= app.path %>/app/.nvmrc'
      - '<%= app.path %>/app/.env.sample'
      - '<%= app.path %>/chart/keystone-cms/Chart.yaml'
      - '<%= app.path %>/chart/keystone-cms/values.yaml'

defaults:
  run:
    shell: bash
    working-directory: '<%= app.path %>/'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.head_ref }}
      - uses: actions/setup-node@v1
        with:
          node-version: '14'
      - uses: actions/cache@v1
        env:
          cache-name: cache-yeoman-node-modules
          hash: libraries/generator-ecommerce-backend/package-lock.json
        with:
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles(env.hash) }}
      - run: npm install --global yo @cowlingj/generator-ecommerce-backend-service  
      - run: yo @cowlingj/ecommerce-backend-service:docs --config
      - name: check if docs different
        id: diff
        run: |-
          git add --intent-to-add ./docs/
          if git diff --summary --exit-code ./docs/; then
            echo "::set-output name=diff::false"
          else
            echo "::set-output name=diff::true"
          fi
      - uses: oleksiyrudenko/gha-git-credentials@v1
        if: steps.diff.outputs.diff == 'true'
        with:
          name: 'Bot'
          email: '09cowlingj+bot@gmail.com'
          actor: 'cowlingj-bot'
          token: '${{ secrets.GH_BOT_TOKEN }}'
      - name: commit diff
        if: steps.diff.outputs.diff == 'true'
        run: |-
          git add ./docs/
          git commit -m "#ci update docs [ci skip]"
      - uses: nick-invision/retry@v1
        if: steps.diff.outputs.diff == 'true'
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |-
            git pull && git push origin
