version: 2.1
# workflows:
#   version: 2
#   build:
#     jobs:
#       - build:
#           filters:
#             branches:
#               only:
#                 - master
jobs:
  build:
    docker:
      - image: docker:19.03.2
    steps:
      - setup_remote_docker
      - checkout
      - docker_package:
          image: "cms.admin"
          path: "cms/main/"
commands:
  docker_package:
    parameters:
      image:
        type: string
      path:
        type: string
    steps:
      - run:
          name: Docker login
          command: echo "$DOCKER_PASS" | docker login --username "$DOCKER_USER" --password-stdin "$DOCKER_REGISTRY"
      - run:
          name: Docker build
          command: docker build -t tmp << parameters.path >>
      - run:
          name: Docker tag [VERSION]
          command: docker tag tmp "$DOCKER_REGISTRY/<< parametes.image >>:$(docker inspect cms --format '{{ index .Config.Labels "version" }}')"
      - run:
          name: Docker tag [LATEST]
          command: docker tag cms "$DOCKER_REGISTRY/<< parametes.image >>:latest"
      - run:
          name: Docker image list
          command: docker image ls
