version: 2.1
workflows:
  version: 2
  workflow:
    jobs:
      - build:
          filters:
            branches:
              only:
                - master
jobs:
  build:
    shell: /bin/sh -leo pipefail
    environment:
      - BASH_ENV: /etc/profile
    docker:
      - image: docker:19.03.2
    steps:
      - setup_remote_docker
      - checkout
      - docker_package:
          image: "cms.admin"
          path: "cms/main/"
          env: "/etc/profile"
commands:
  docker_package:
    parameters:
      image:
        type: string
      path:
        type: string
      env:
        type: string
    steps:
      - run:
          name: Docker login
          command: echo "$DOCKER_PASS" | docker login --username "$DOCKER_USER" --password-stdin "$DOCKER_REGISTRY"
      - run:
          name: Docker build
          command: docker build -t tmp << parameters.path >>
      - run:
          name: Set image version
          command: echo "export IMAGE_VERSION=$(docker inspect tmp --format '{{ index .Config.Labels "version" }}')" >> << parameters.env >>
      - run:
          name: Docker tag
          command: |
            docker tag tmp "$DOCKER_REGISTRY/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/<< parameters.image >>:$IMAGE_VERSION"
            docker tag tmp "$DOCKER_REGISTRY/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/<< parameters.image >>:latest"
      - run:
          name: Docker push
          command: |
            docker push "$DOCKER_REGISTRY/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/<< parameters.image >>:$IMAGE_VERSION"
            docker push "$DOCKER_REGISTRY/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/<< parameters.image >>:latest"
